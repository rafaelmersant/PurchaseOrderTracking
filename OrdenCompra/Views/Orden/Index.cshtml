@{
    ViewBag.Title = "Orden de Compra";
}

<style>
    .disable-button {
        cursor: not-allowed;
    }

    .field-updated {
        background-color: lightyellow;
    }

    .field-will-be-removed {
        background-color: lightcoral;
    }
</style>

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<link href="~/Content/toastr.css" rel="stylesheet" type="text/css" />

<div class="text-center mb-1" style="position: relative">

    <div class="text-right" id="formHeaderInfo" style="right: 20px; top:10px; position: absolute">
        <a href="javascript:void(0);" class="fa fa-list h6" id="btn-detail"></a>
        @*<span class="text-light">Fecha Creación: <span id="requestedDate" class="font-weight-bold"></span> </span>*@
        @*<span class="ml-3 text-light">Estatus: <span id="requestStatus" class="font-weight-bold"></span></span>*@
    </div>

</div>

<div class="container-fluid orden-compra">
    <section class="bg-light text-dark border-custom mb-2">
        <div class="bg-secondary text-light panel-custom border">
            <h6 class="panel-title">
                Orden de Compra: Información de Cabecera
            </h6>
        </div>

        <form class="mt-1 ml-2 mr-2">
            <div class="form-row">

                <div class="form-group col-lg-3 col-md-4 col-sm-12">
                    <div class="row">
                        <div class="col-6 mb-1">
                            <label for="validationDefault01">Orden No.</label>
                            <input type="text" id="orderId" name="orderId" value="" class="form-control form-control-sm numericOnly" autocomplete="off" style="min-width: 65px !important" />
                        </div>

                        <div class="col-6">
                            <a class="btn btn-sm btn-info" href="javascript:void(0)" id="btnSearchOrder" title="Buscar" style="margin-top: 20px">
                                <i class="fa fa-search"></i>
                            </a>
                            <span id="waitingIndicator" class="spinner-border text-danger" style="margin-top: 23px; margin-right: 5px; display: none"></span>
                        </div>
                    </div>
                </div>

                <div class="form-group col-lg-2 col-md-3 col-sm-12">
                    <label for="orderDate">Estatus</label>
                    @Html.DropDownList("OrderStatusId", new SelectList(ViewBag.OrderStatus, "Value", "Text"), new
                     {
                         @class = "form-control form-control-sm small-box",
                         @style = "border: 1px solid lightgray; color: gray;"
                     })
                </div>

                <div class="form-group col-lg-2 col-md-2 col-sm-12">
                    <label for="orderDate">Fecha de Orden</label>
                    <input type="text" id="orderDate" name="orderDate" value="" class="form-control form-control-sm col-12 datepicker" />
                </div>

                @*<div class="form-group col-lg-2 col-md-2 col-sm-12">
                        <label for="orderDateOpen">Fecha de Apertura</label>
                        <input type="text" id="orderDateOpen" name="orderDateOpen" value="" class="form-control form-control-sm col-12 datepicker" />
                    </div>*@

                <div class="form-group col-lg-5 col-md-4 col-sm-12">
                    <label for="validationDefault01">Suplidor</label>
                    <input type="text" id="provider" name="provider" value="" class="form-control form-control-sm col-12" readonly />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col">
                    <label for="validationDefault01">Observación</label>
                    <input type="text" id="observation" name="observation" value="" class="form-control form-control-sm col-12" />
                </div>
            </div>
        </form>
    </section>

    <section id="massive-update" class="bg-light-gray pb-2 mb-3" style="display:none;">
        <div class="bg-secondary text-light panel-custom border">
            <h6 id="title-massive" class="panel-title" style="cursor: pointer;">+ Actualización masiva de datos en contenedores</h6>
        </div>

        <div class="form-row">
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label class="font-weight-bold">Filtrar por</label>
                <select id="selectBy" class="form-control form-control-sm small-box">
                    <option value="Articulo">Articulos</option>
                    <option value="Contenedor">Contenedores</option>
                    <option value="FechaEntrega">Fecha de Entrega</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group ml-2 col-lg-5 col-md-5 col-sm-12" id="articles-massive-div">
                <label for="articles-massive">Articulos</label>
                <div id="articles-massive"></div>
            </div>

            <div class="form-group ml-2 col-lg-3 col-md-3 col-sm-12" id="container-massive-div">
                <label for="containersMassive">Contenedores</label>
                <div id="containersMassive" class="containers-massive-style"></div>
            </div>

            <div class="form-group ml-2 col-lg-2 col-md-2 col-sm-12" id="due-date-filter-div" style="display: none">
                <label for="dueDateFilter">Fecha Entrega</label>
                <input type="text" id="dueDateFilter" name="dueDateFilter" value="" class="form-control form-control-sm datepicker" autocomplete="off" />
            </div>
        </div>

        <div class="form-row">
            <div class="mt-1 ml-2 col-lg-12 col-md-12 col-sm-12">
                <label class="font-weight-bold">Campos disponibles para actualizar</label>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label for="manufacturingDateMassive">Fecha Fabricación:</label>
                <input type="text" id="manufacturingDateMassive" name="manufacturingDateMassive" value="" class="form-control form-control-sm datepicker" autocomplete="off" />
            </div>
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label for="dueDateMassive">Fecha Entrega:</label>
                <input type="text" id="dueDateMassive" name="dueDateMassive" value="" class="form-control form-control-sm datepicker" autocomplete="off" />
            </div>
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label for="BLMassive">BL</label>
                <input type="text" id="BLMassive" name="BLMassive" class="form-control form-control-sm" autocomplete="off" />
            </div>
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label for="navieraMassive">Puerto</label>
                <div id="container-naviera-massive-div"></div>
            </div>
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <label for="statusMassive">Estatus</label>
                <div id="container-estatus-massive-div"></div>
            </div>
        </div>

        <div class="form-row mt-2">
            <div class="form-group ml-2 col-3" style="max-width: 230px">
                <button class="btn btn-danger btn-sm" id="ApplyChanges">Aplicar cambios masivos</button>
                <span id="waitingIndicatorMassive" class="spinner-border text-danger float-right" style="margin-right: 5px; display: none"></span>
            </div>
        </div>
    </section>

    <form id="upload-files" class="bg-light-gray pb-2 mb-3" enctype="multipart/form-data" style="display:none;">
        <div class="bg-secondary text-light panel-custom border">
            <h6 id="title-upload" class="panel-title" style="cursor: pointer;">+ Subir documentos (archivos)</h6>
        </div>

        <div class="form-row">
            <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                <input type="file" class="form-control-file" id="fileUploadOrder" name="file" style="display: none">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group ml-2 col-lg-6 col-md-6 col-sm-12">
                <label for="FileNameOrderText">Nombre de archivo</label>
                <br />
                <input type="text" id="FileNameOrderText" name="FileNameOrderText" class="form-control form-control-sm d-inline" readonly />
                <span onclick="document.getElementById('fileUploadOrder').click(); return false;" class="fa fa-search d-inline h6" style="cursor: pointer"></span>
            </div>
        </div>

        <div class="form-row mt-2">
            <div class="form-group ml-2 col-lg-6 col-md-6 col-sm-12">
                <label for="FileDescription">Descripción</label>
                <input type="text" id="FileDescription" name="FileDescription" class="form-control form-control-sm" autocomplete="off" />
            </div>
        </div>

        <div class="form-row mt-2">
            <div class="form-group ml-2 col-lg-6 col-md-6 col-sm-12">
                <button class="btn btn-danger btn-sm" id="SaveDocFile">Guardar archivo</button>
                <span id="waitingIndicatorFile" class="spinner-border text-danger float-left" style="margin-right: 5px; display: none"></span>
            </div>
        </div>

        <div class="form-row mt-2">
            <div class="form-group ml-2 col-lg-6 col-md-6 col-sm-12">
                <div id="uploaded-files"></div>
            </div>
        </div>

    </form>

    <a href="javascript:void(0);" id="btnToggleContainers" onclick="toggleContainers()" class="text-info" style="display:none;">Reducir todos los contenedores</a>
    <section id="containers-section" style="overflow-y:scroll; overflow-x: hidden; max-height:500px; display:none;">
        <div id="containers"></div>
    </section>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="~/Scripts/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/dataTables.bootstrap4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="~/Scripts/toastr.js"></script>
}

<script type="text/javascript">
    var orderDetails;

    $(document).ready(async function () {
        $("#container-massive-div").hide();
        $("#massive-update").hide();
        $("#upload-files").hide();
        $("#massive-update .form-row").fadeOut();
        $("#upload-files .form-row").fadeOut();
        $("#btn-detail").hide();
        $("#QueryOrder").addClass("menu-active");
        $("#btnSearchOrder").removeClass("disabled");
        $("#btnToggleContainers").hide();

        const orderId = new URLSearchParams(window.location.search).get('id');

        if (orderId) {
            $("#orderId").val(orderId);
            await getPurchaseOrderDetail(orderId);
        }

        $(".datepicker").datepicker(
            {
                dateFormat: 'dd/mm/yy',
                //beforeShowDay: $.datepicker.noWeekends
            }
        );

        $(".numericOnly").keypress(function (e) {
            if (String.fromCharCode(e.keyCode).match(/[^0-9]/g)) return false;
        });

        $("#orderId").keypress(function (evt) {
            if (evt.charCode === 13 && this.value.length >= 1) {
                $("#btnSearchOrder").click();
            }

            if (this.value.length >= 5)
                return false;
        });

        $("#observation").keypress(function (evt) {
            if (this.value.length > 200)
                return false;
        });

        $("#btnSearchOrder").click(async function (e) {
            e.preventDefault();

            //var currentURL = window.location.href;
            //var url = new URL(currentURL);
            //url.searchParams.delete('id');
            //window.history.replaceState({}, '', url);

            const orderId = $("#orderId").val();

            if (orderId) {
                await getPurchaseOrderDetail(orderId)
            }
        });

        $("#ApplyChanges").click(async function (evt) {
            evt.preventDefault();
            evt.stopPropagation();

            const dueDateMassive = $("#dueDateMassive").val();
            const manufacturingDateMassive = $("#manufacturingDateMassive").val();
            const BLMassive = $("#BLMassive").val();
            const dueDateFilter = $("#dueDateFilter").val();
            const navieraMassive = $("#navieraMassive").val();
            const statusMassive = $("#statusMassive").val();
            const containers = $("#containers-massive").val();

            if (!dueDateMassive && !manufacturingDateMassive && !BLMassive && !navieraMassive && !statusMassive) {
                toastr.error("Debe digitar un valor para aplicar cambios masivos.");
                return false;
            }

            let updated = false;

            if (await confirm(`Esta seguro que desea aplicar los cambios masivos?`)) {
                $("#waitingIndicatorMassive").show();

                const data = $("#selectBy").val() === "Articulo" && !containers? $(".article-massive-value") : [{ id: 0, checked: true }];

                for (const item of data) {
                    let articleId = 0;
                    const orderId = $("#orderId").val();

                    if ($("#selectBy").val() === "Articulo" && !containers)
                        articleId = item.id.split("-")[1];

                    if (item.checked) {

                        if (dueDateMassive) {
                            await $.ajax({
                                "url": `/Orden/UpdateContainerFieldByArticle?orderId=${orderId}&articleId=${articleId}&containers=${containers}&dueDate=${dueDateFilter}&type=DueDate&value=${dueDateMassive}`,
                                "type": "POST",
                                "success": async function (response) {
                                    console.log('response:', response);
                                    updated = true;
                                }
                            });
                        }

                        if (manufacturingDateMassive) {
                            await $.ajax({
                                "url": `/Orden/UpdateContainerFieldByArticle?orderId=${orderId}&articleId=${articleId}&containers=${containers}&dueDate=${dueDateFilter}&type=ManufacturingDate&value=${manufacturingDateMassive}`,
                                "type": "POST",
                                "success": async function (response) {
                                    console.log('response:', response);
                                    updated = true;
                                }
                            });
                        }

                        if (BLMassive) {
                            await $.ajax({
                                "url": `/Orden/UpdateContainerFieldByArticle?orderId=${orderId}&articleId=${articleId}&containers=${containers}&dueDate=${dueDateFilter}&type=BL&value=${BLMassive}`,
                                "type": "POST",
                                "success": async function (response) {
                                    console.log('response:', response);
                                    updated = true;
                                }
                            });
                        }

                        if (navieraMassive) {
                            await $.ajax({
                                "url": `/Orden/UpdateContainerFieldByArticle?orderId=${orderId}&articleId=${articleId}&containers=${containers}&dueDate=${dueDateFilter}&type=Naviera&value=${navieraMassive}`,
                                "type": "POST",
                                "success": async function (response) {
                                    console.log('response:', response);
                                    updated = true;
                                }
                            });
                        }

                        if (statusMassive) {
                            await $.ajax({
                                "url": `/Orden/UpdateContainerFieldByArticle?orderId=${orderId}&articleId=${articleId}&containers=${containers}&dueDate=${dueDateFilter}&type=Status&value=${statusMassive}`,
                                "type": "POST",
                                "success": async function (response) {
                                    console.log('response:', response);
                                    updated = true;
                                }
                            });
                        }
                    }
                }

                //clean fields
                $("#dueDateMassive").val('');
                $("#manufacturingDateMassive").val('');
                $("#BLMassive").val('');
                $("#dueDateFilter").val('');
                $("#navieraMassive").val('');
                $("#statusMassive").val('');
            }

            if (!updated) {
                toastr.error("Debe seleccionar al menos un articulo para aplicar los cambios.");
                $("#waitingIndicatorMassive").hide();
            }
            else {
                setTimeout(() => {
                    $("#waitingIndicatorMassive").hide();
                    toastr.success("Cambios aplicados con exito!");
                    $("#btnSearchOrder").click();
                },3000)
            }
        })

        $("#btn-detail").click(function (evt) {
            const OrdenNo = $("#orderId").val();
            window.location = `/Orden/Detalle/${OrdenNo}`;
        });

        $("#title-massive").click(function (evt) {
            evt.preventDefault();
            evt.stopPropagation();

            if ($("#title-massive").html() === "+ Actualización masiva de datos en contenedores") {
                $("#title-massive").html("- Actualización masiva de datos en contenedores");

                $("#massive-update .form-row").fadeIn();
            }
            else {
                $("#title-massive").html("+ Actualización masiva de datos en contenedores");
                $("#massive-update .form-row").fadeOut();
            }
        });

        $("#title-upload").click(function (evt) {
            evt.preventDefault();
            evt.stopPropagation();

            if ($("#title-upload").html() === "+ Subir documentos (archivos)") {
                $("#title-upload").html("- Subir documentos (archivos)");

                $("#upload-files .form-row").fadeIn();
            }
            else {
                $("#title-upload").html("+ Subir documentos (archivos)");
                $("#upload-files .form-row").fadeOut();
            }
        });

        $("#selectBy").on("change", function (evt) {
            $("#articles-massive-div").hide();
            $("#container-massive-div").hide();
            $("#due-date-filter-div").hide();

            if (this.value === "Articulo") {
                $("#articles-massive-div").show();
            }

            if (this.value === "Contenedor") {
                renderArticleContainer(orderDetails.message.Containers);
                $("#container-massive-div").show();

                for (let item of $(".article-massive-value"))
                    item.checked = false;
            }

            if (this.value === "FechaEntrega") {
                $("#due-date-filter-div").show();
            }
        });

        $("#fileUploadOrder").change(function (evt) {
            const selectedFile = this.files[0];
            console.log('selected file:', selectedFile)
            if (selectedFile) {
                $("#FileNameOrderText").val(selectedFile.name);
            }
        });

        $("#SaveDocFile").click(function (evt) {
            evt.preventDefault();
            evt.stopPropagation();

            const orderId = $("#orderId").val();
            const fileDescription = $("#FileDescription").val();

            if (!orderId || !fileDescription) {
                toastr.error("Favor especificar la descripción del archivo.");
                return false;
            }

            var formData = new FormData();
            var fileInput = $("input[type='file']")[0].files[0];

            if (fileInput) {
                formData.append("file", fileInput);
                formData.append("orderId", orderId);
                formData.append("description", fileDescription);

                $.ajax({
                    url: "/Orden/UploadFile",
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) {
                        if (data.result === "200") {
                            toastr.success("El archivo fue guardado satisfactoriamente!");
                            $("#FileDescription").val('');
                            $("#FileNameOrderText").val('');
                            $("input[type='file']").val('');

                            getUploadedFiles($("#orderId").val());
                        } else {
                            toastr.error(data.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                        toastr.error("Error tratando de guardar el archivo: " + error);
                    }
                });
            } else {
                toastr.error("No ha seleccionado ningun archivo.");
            }
        });
    });

    function deleteFile(id, fileName) {

        if (confirm(`Esta seguro de eliminar el archivo: ${fileName}?`)) {

            $.ajax({
                "url": `/Orden/DeleteFile?id=${id}`,
                "type": "POST",
                "success": async function (response) {
                    if (response.result === "200") {
                        toastr.success(`El archivo: ${fileName} fue eliminado con exito!`);
                        getUploadedFiles($("#orderId").val());
                    } else {
                        toastr.error(response.message);
                    }
                }
            });
        }
    }

    function getUploadedFiles(orderId) {
        $.ajax({
            "url": `/Orden/GetUploadedFiles?orderId=${orderId}`,
            "type": "POST",
            "success": async function (response) {
                if (response.result === "200") {
                    let docs = [];
                    for (const doc of response.message) {
                        docs.push(`<a href="/Documentos/${doc.Url}" class="text-custom">${doc.FileName}</a>
                                   <span class='fa fa-trash text-custom h6' style='cursor: pointer;' onclick="deleteFile(${doc.Id}, '${doc.FileName}')" title="Eliminar"> </span> <br/>`);
                    }

                    $("#uploaded-files").html(`<span class="mt-2"> <strong>Archivos adjuntos:</strong> </span><br/>`);
                    $("#uploaded-files").append(docs);

                    if (!docs.length)
                        $("#uploaded-files").html("");
                }
            }
        });
    }

    function getPurchaseOrderDetail(orderId) {
        console.log('SEARCH ORDER ID:', orderId);

        $("#provider").val("");
        $("#requestedDate").html("");
        $("#requestStatus").html("");
        $("#observation").val("");
        $("#containers").html("");
        $("#OrderStatusId").val("");
        $("#orderDate").val("");

        $("#waitingIndicator").show();
        $("#btnSearchOrder").hide();
        $("#btnToggleContainers").hide();

         $.ajax({
            "url": `/Orden/GetPurchaseOrder?orderId=${orderId}`,
            "type": "POST",
            "success": async function (response) {
                if (response.result === "200") {
                    $("#btn-detail").show();
                    $("#containers-section").show();

                    getUploadedFiles(orderId);

                    console.log('ORDER CREATED!')
                    console.log(response);
                    orderDetails = response;

                    //Get unique articles from this order
                    const articles = response.message.Containers.map(item => (
                        {
                            "Id": item.Details[0].ArticleId,
                            "Description": item.Details[0].Description
                        }
                    ));

                    const unique_articles = articles.filter((item, index) => {
                        return index === articles.findIndex(o => item.Id === o.Id);
                    });

                    $("#provider").val(`${response.message.Header.ProviderId}-${response.message.Header.ProviderName}`);
                    //$("#requestedDate").html(`${response.message.Header.CreatedDate}`);
                    $("#orderDate").val(`${GetSpanishDate(response.message.Header.DateDMA)}`);
                    $("#orderDateOpen").val(`${GetSpanishDate(response.message.Header.DateDMA)}`);
                    $("#OrderStatusId").val(`${response.message.Header.StatusId}`);
                    $("#observation").val(`${response.message.Header.Observation}`);

                    if (response.message.Containers.length > 1) {
                        $("#btnToggleContainers").show();

                        let articlesMassive = [];
                        for (const article of unique_articles) {
                            articlesMassive.push(`<input type="checkbox" class="article-massive-value" id="article-${article.Id}""/> <label for="article-${article.Id}" style="cursor: pointer;">${article.Id} - ${article.Description}</label> <br/>`);
                        }
                        $("#articles-massive").html(articlesMassive);

                        $("#massive-update").fadeIn();
                        $("#upload-files").fadeIn();

                        $(".article-massive-value").click(function (evt) {
                            const articlesGroup = $(".article-massive-value");
                            let selectedArticles = [];
                            for (const _article of articlesGroup) {
                                if (_article.checked)
                                    selectedArticles.push(parseInt(_article.id.split("-")[1]));
                            }

                            console.log('selectedArticles:', selectedArticles);
                            if (selectedArticles.length > 0) {
                                $("#container-massive-div").show();
                                $("#due-date-filter-div").show();

                                const filteredContainers = orderDetails.message.Containers.filter(function (container) {
                                    return container.Details.some(function (detail) {
                                        return selectedArticles.includes(detail.ArticleId);
                                    })
                                });

                                renderArticleContainer(filteredContainers);
                            } else {
                                $("#container-massive-div").hide();
                                $("#due-date-filter-div").hide();
                            }
                        });

                        //Navieras
                        let _navieras = @Html.Raw(Json.Encode(ViewBag.Navieras));
                        let navieras = [];
                        navieras.push(`<option value=""></option>`);

                        for (const naviera of _navieras) {
                            navieras.push(`<option value="${naviera.Id}">${naviera.Description}->${naviera.Port}</option>`)
                        }
                        $("#container-naviera-massive-div").html(`<select class="form-control form-control-sm small-box" id="navieraMassive">
                                                                    ${navieras}
                                                                  </select>`);

                        //Containers
                        //renderArticleContainer(response.message.Containers);

                        //Container Status
                        let _containerStatus = @Html.Raw(Json.Encode(ViewBag.ContainerStatus));
                        let containerStatus = [];
                        containerStatus.push(`<option value=""></option>`);

                        for (const status of _containerStatus) {
                            containerStatus.push(`<option value="${status.Id}">${status.Description}</option>`)
                        }
                        $("#container-estatus-massive-div").html(`<select class="form-control form-control-sm small-box" id="statusMassive">
                                                                    ${containerStatus}
                                                                  </select>`);
                    }

                    let views = [];
                    for (const container of response.message.Containers) {
                        views.push(renderContainer(container, unique_articles));
                    }

                    $("#containers").html(views);

                    $('.quantityField').blur(function () {

                        const newValue = $(this).val();
                        const previousValue = $(this)[0].defaultValue;

                        if (newValue !== previousValue) {
                            $(this).addClass('field-updated');
                        }
                    });

                    $(".datepicker").datepicker(
                        {
                            dateFormat: 'dd/mm/yy'
                        }
                    );

                    $(".container-save").on('click', function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = $(this)[0].id.split('-')[2];
                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);
                        const BL = $(`#BL-${containerId}`).val();

                        for (const item of container[0].Details) {
                            if ($(`#article-quantity-${item.Id}`).hasClass("field-updated")
                                || $(`#article-traffic-${item.Id}`).hasClass("field-updated")
                                || $(`#article-factory-${item.Id}`).hasClass("field-updated")
                                || $(`#BL-${containerId}`).hasClass("field-updated")) {

                                const newQuantity = $(`#article-quantity-${item.Id}`).val();
                                const trafficQuantity = $(`#article-traffic-${item.Id}`).val();
                                const factoryQuantity = $(`#article-factory-${item.Id}`).val();

                                $.ajax({
                                    "url": `/Orden/UpdateQuantityField?detailId=${item.Id}&newQuantity=${newQuantity}&traffic=${trafficQuantity}&factory=${factoryQuantity}&BL=${BL}`,
                                    "type": "POST",
                                    "success": async function (response) {
                                        if (response.result === "200" || response.result === "201") {
                                            $(`#article-quantity-${item.Id}`).removeClass("field-updated");
                                            $(`#BL-${containerId}`).removeClass("field-updated");

                                            toastr.success(`Los datos fueron actualizados para el contenedor #: ${container[0].container.SortIndex}`);

                                            setTimeout(() => {
                                                if (response.result === "201") {
                                                    $("#btnSearchOrder").click();
                                                }
                                            }, 2500);
                                        }
                                        else
                                            toastr.error(`Hubo un error al tratar de actualizar los datos para el contenedor: ${container[0].container.SortIndex}`);
                                    }
                                });
                            }
                        }
                    });

                    $(".add-article").on('click', function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = $(this)[0].id.split('-')[2];
                        $(`#panel-add-article-${containerId}`).fadeIn();
                    });

                    $(".add-article-cancel").on('click', function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = $(this)[0].id.split('-')[3];
                        $(`#panel-add-article-${containerId}`).fadeOut();
                        $(`#add-article-quantity-${containerId}`).val('');
                    });

                    $(".add-article-save").on('click', function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = $(this)[0].id.split('-')[3];
                        const articleId = $(`#add-article-data-${containerId}`).val();
                        const quantity = $(`#add-article-quantity-${containerId}`).val();

                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);

                        if (quantity <= 0) {
                            toastr.error("Favor digitar una cantidad valida para el articulo que esta tratando de agregar.");
                            return false;
                        }

                        if (confirm(`Esta seguro que desea agregar el articulo para el contenedor #${container[0].container.SortIndex}?`)) {
                            $.ajax({
                                "url": `/Orden/AddNewArticleToContainer?containerId=${containerId}&articleId=${articleId}&quantity=${quantity}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200") {
                                        toastr.success(`Articulo agregado para el contenedor #${container[0].container.SortIndex}`);
                                        setTimeout(() => {
                                            $("#btnSearchOrder").click();
                                        }, 2000)
                                    }
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de agregar el articulo.");
                                }
                            });
                        } else {
                            $(`#${evt.currentTarget.id}`).val(container[0].container.ShippingCompanyId);
                        }
                    });

                    $("#orderDate").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const orderId = $("#orderId").val();
                        const previousDate = GetSpanishDate(orderDetails.message.Header.DateDMA);

                        if ($(this).val() === previousDate) return false;

                        if (confirm(`Esta seguro que desea cambiar la fecha de para esta orden?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateOrderField?orderId=${orderId}&type=orderDate&value=${$(`#orderDate`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Fecha actualizada para la orden #${orderId}`);
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar la fecha para esta orden.");
                                }
                            });
                        } else {
                            $(`#orderDate`).val($(this)[0].defaultValue);
                        }
                    });

                    $("#OrderStatusId").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const orderId = $("#orderId").val();

                        if (confirm(`Esta seguro que desea cambiar el estatus para esta orden?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateOrderField?orderId=${orderId}&type=status&value=${$(`#OrderStatusId`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Estatus actualizado para la orden #${orderId}`);
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar el estatus para esta orden.");
                                }
                            });
                        } else {
                            $(`#OrderStatusId`).val(orderDetails.message.Header.StatusId);
                        }
                    });

                    $(".containerManufacturingDate").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = evt.currentTarget.id.split("-")[1];
                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);

                        if (confirm(`Esta seguro que desea cambiar la fecha de fabricación para el contenedor #${container[0].container.SortIndex}?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateContainerField?containerId=${containerId}&type=ManufacturingDate&value=${$(`#${evt.currentTarget.id}`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Fecha de fabricación actualizada para el contenedor #${container[0].container.SortIndex}`);
                                    else {
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar la fecha de fabricación para este contenedor.");
                                    }
                                }
                            });
                        } else {
                            $(`#${evt.currentTarget.id}`).val($(this)[0].defaultValue);
                        }
                    });

                    $(".containerDueDate").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = evt.currentTarget.id.split("-")[1];
                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);

                        if (confirm(`Esta seguro que desea cambiar la fecha de entrega para el contenedor #${container[0].container.SortIndex}?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateContainerField?containerId=${containerId}&type=DueDate&value=${$(`#${evt.currentTarget.id}`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Fecha de entrega actualizada para el contenedor #${container[0].container.SortIndex}`);
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar la fecha de entrega para este contenedor.");
                                }
                            });
                        } else {
                            $(`#${evt.currentTarget.id}`).val($(this)[0].defaultValue);
                        }
                    });

                    $(".containerStatus").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = evt.currentTarget.id.split("-")[2];
                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);

                        if (confirm(`Esta seguro que desea cambiar el estatus para el contenedor #${container[0].container.SortIndex}?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateContainerField?containerId=${containerId}&type=Status&value=${$(`#${evt.currentTarget.id}`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Estatus actualizado para el contenedor #${container[0].container.SortIndex}`);
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar el estatus para este contenedor.");
                                }
                            });
                        }
                        else {
                            $(`#${evt.currentTarget.id}`).val(container[0].container.StatusId);
                        }
                    });

                    $(".containerNaviera").on("change", function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();

                        const containerId = evt.currentTarget.id.split("-")[2];
                        const container = orderDetails.message.Containers.filter(c => c.container.Id == containerId);

                        if (confirm(`Esta seguro que desea cambiar la naviera para el contenedor #${container[0].container.SortIndex}?`)) {
                            $.ajax({
                                "url": `/Orden/UpdateContainerField?containerId=${containerId}&type=Naviera&value=${$(`#${evt.currentTarget.id}`).val()}`,
                                "type": "POST",
                                "success": async function (response) {
                                    if (response.result === "200")
                                        toastr.success(`Naviera actualizada para el contenedor #${container[0].container.SortIndex}`);
                                    else
                                        if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                                            toastr.error(response.message);
                                            setTimeout(() => {
                                                window.location.reload(true);
                                            }, 2500);
                                        }
                                        else
                                            toastr.error("Hubo un error al tratar de actualizar la naviera para este contenedor.");

                                }
                            });
                        } else {
                            $(`#${evt.currentTarget.id}`).val(container[0].container.ShippingCompanyId);
                        }
                    });
                }
                else {
                    console.log(response.message);
                    if (response.message.includes('(403)') || response.result === '404' || response.message.includes("505")) {
                        toastr.error(response.message);
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 2500);
                    }
                    else
                        toastr.error(`Hubo un error tratando de encontrar la orden de compra #${orderId}`);
                }

                $("#waitingIndicator").hide();
                $("#btnSearchOrder").show();
             }
        });
    }

    function renderContainer(container, _articles) {
        let dueDate = "";
        let manufacturingDate = "";

        if (container.container.DueDate && container.container.DueDate.length === 10) {
            dueDate = GetSpanishDate(container.container.DueDate);
        }

        if (container.container.ManufacturingDate && container.container.ManufacturingDate.length === 10) {
            manufacturingDate = GetSpanishDate(container.container.ManufacturingDate);
        }

        //Navieras
        let _navieras = @Html.Raw(Json.Encode(ViewBag.Navieras));
        let navieras = [];
        navieras.push(`<option value=""></option>`);

        for (const naviera of _navieras) {
            navieras.push(`<option value="${naviera.Id}" ${container.container.ShippingCompanyId === parseInt(naviera.Id) ? "selected" : ""}>${naviera.Description}->${naviera.Port}</option>`)
        }

        //Container Status
        let _containerStatus = @Html.Raw(Json.Encode(ViewBag.ContainerStatus));
        let containerStatus = [];
        containerStatus.push(`<option value=""></option>`);

        for (const status of _containerStatus) {
            containerStatus.push(`<option value="${status.Id}" ${container.container.StatusId === parseInt(status.Id) ? "selected" : ""}>${status.Description}</option>`)
        }

        //Articles
        let articles  = [];

        for (const article of _articles) {
            articles.push(`<option value="${article.Id}">${article.Id} - ${article.Description}</option>`)
        }

        let view =
           `<panel id="containerId" class="bg-light text-dark border-custom panel-container">
            <div class="bg-secondary text-light border">
                <div class="form-row">

                    <div class="form-group pl-2 pt-3 col-lg-2 col-md-2 col-sm-12">
                        <a href="javascript:void(0)" id="toggleContainer-${container.container.SortIndex}" onclick="toggleContainer(${container.container.SortIndex});" class="border p-2 pl-2 pr-2 mr-2 fa fa-minus"></a>
                        <span class="panel-title" id="container-title"><b>Contenedor #${container.container.SortIndex}</b></span>
                    </div>

                    <div class="form-group mt-1 ml-2 col-lg-1 col-md-1 col-sm-12">
                        <label for="container-estatus-${container.container.Id}">Estatus</label>
                        <select class="form-control form-control-sm small-box bg-secondary text-light containerStatus" id="container-estatus-${container.container.Id}">
                           ${containerStatus}
                        </select>
                    </div>

                    <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="container-naviera-${container.container.Id}">Puerto</label>
                        <select class="form-control form-control-sm small-box bg-secondary text-light containerNaviera" id="container-naviera-${container.container.Id}">
                            ${navieras}
                        </select>
                    </div>

                    <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="BL-${container.container.Id}">BL</label>
                        <input type="text" id="BL-${container.container.Id}" name="BL" value="${container.container.BL}" class="form-control form-control-sm bg-light-gray quantityField containerBL" autocomplete="off"/>
                    </div>

                    <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="manufacturingDate-${container.container.Id}">Fecha Fabricación:</label>
                        <input type="text" id="manufacturingDate-${container.container.Id}" name="manufacturingDate" value="${manufacturingDate}" class="form-control form-control-sm bg-light-gray datepicker containerManufacturingDate" autocomplete="off"/>
                    </div>

                    <div class="form-group mt-1 ml-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="dueDate-${container.container.Id}">Fecha Entrega:</label>
                        <input type="text" id="dueDate-${container.container.Id}" name="dueDate" value="${dueDate}" class="form-control form-control-sm bg-light-gray datepicker containerDueDate" autocomplete="off"/>
                    </div>
                </div>
            </div>

            <section>
                <table id="container-articles-table-${container.container.SortIndex}" class="table table-striped table-bordered table-condensed table-sm containersTable">
                    <thead class="bg-dark text-light">
                        <tr>
                            <th style='width:50px;' class='text-center'>
                                #
                            </th>
                            <th style='width:80px;'>
                                Cant.
                            </th>
                            <th style='width:85px;'>
                                Código
                            </th>
                            <th>
                                Descripción
                            </th>

                            <th>
                                Marca
                            </th>
                            <th>
                                Modelo
                            </th>
                            <th class='text-center'>
                                Inventario
                            </th>
                            <th class='text-center'>
                                Transito
                            </th>
                            <th class='text-center'>
                                Fabrica
                            </th>
                        </tr>
                    </thead>
                    <tbody>`;

        let quantityTotal = 0;
        let total = 0;
        let counter = 0;

        for (const item of container.Details) {
            quantityTotal += item.QuantityRequested;
            total += item.QuantityRequested * item.Price;
            counter++;

            view += `
             <tr>
                <td style='width:50px;' class='text-center'>
                    ${counter}
                </td>
                <td style='width:80px;'>
                    <input type="text" id="article-quantity-${item.Id}" name="article-quantity-${item.Id}" value="${item.QuantityRequested}" class="form-control form-control-sm numericOnly quantityField" style="max-width: 100px" autocomplete="off" />
                </td>
                <td style='width:85px;'>
                    ${item.ArticleId}
                </td>
                <td>
                    ${item.Description}
                </td>
                <td>
                    ${item.Mark}
                </td>
                <td>
                    ${item.Model}
                </td>
                <td class="text-center" style='width:80px;'>
                    ${item.InventoryStock}
                </td>
                <td class="text-center" style='width:80px;'>
                    <input type="text" id="article-traffic-${item.Id}" name="article-traffic-${item.Id}" value="${item.QuantityTraffic}" class="form-control form-control-sm numericOnly quantityField" style="max-width: 100px" autocomplete="off" />
                </td>
                <td class="text-center" style='width:80px;'>
                    <input type="text" id="article-factory-${item.Id}" name="article-factory-${item.Id}" value="${item.QuantityFactory}" class="form-control form-control-sm numericOnly quantityField" style="max-width: 100px" autocomplete="off" />
                </td>
            </tr>`
        }
        view += `</tbody>`;
        view += `<tfoot class="bg-light">`;
        //view += `<tr>
        //                <td>
        //                 <b>Total<b>
        //                </td>
        //                <td>
        //                    <span id="article-quantity-total"><b>${formatNumber(quantityTotal)}</b></span>
        //                </td>
        //                <td>
        //                </td>
        //                <td>
        //                </td>
        //                <td>
        //                </td>
        //                <td>
        //                </td>
        //                <td>
        //                </td>
        //                <td class='text-right'>
        //                    <span id="article-price-total"><b>${formatNumber(total)}</b></span>
        //                </td>
        //            </tr>`;
        view += `
             <tr id="panel-add-article-${container.container.Id}" style="display:none" class="bg-warning">
                <td> </td>
                <td style='width:80px;'>
                    <input type="text" id="add-article-quantity-${container.container.Id}" name="add-article-quantity-${container.container.Id}" value="" placeholder="Cant." class="form-control form-control-sm numericOnly" style="width: 100%" autocomplete="off" />
                </td>
                <td colspan="2">
                    <select class="form-control form-control-sm small-box" style="max-width: 100%" id="add-article-data-${container.container.Id}">
                     ${articles}
                    </select>
                </td>
                <td colspan="6">
                    <a href="javascript:void(0);" id="add-article-save-${container.container.Id}" class="btn btn-danger btn-sm add-article-save">Agregar</a>
                    <a href="javascript:void(0);" id="add-article-cancel-${container.container.Id}" class="btn btn-dark btn-sm add-article-cancel">Cancelar</a>
                </td>
            </tr>`;

        view +=     `<tr class="bg-light">
                        <td colspan="9">
                            <a href="javascript:void(0);" id="container-save-${container.container.Id}" class="btn btn-danger btn-sm container-save">Guardar cambios para Contener #${container.container.SortIndex}</a>
                            <a href="javascript:void(0);" id="add-article-${container.container.Id}" class="btn btn-info btn-sm add-article">Agregar articulo al contenedor #${container.container.SortIndex}</a>
                        </td>
                    </tr>
                </tfoot>`;

        view += `</table>
        </section>
        </panel>`

        return view;
    }

    function renderArticleContainer(_containers) {
        let containers = [];
        for (const container of _containers) {
            containers.push(`<option value="${container.container.Id}">Contenedor ${container.container.SortIndex}</option>`)
        }
        $("#containersMassive").html(`<select name="containers-massive" id="containers-massive" class="form-control form-control-sm containers-massive-style" multiple>
                                                       ${containers}
                                      </select>`);

        const articlesDivHeight = $('#articles-massive').height();
        $(".containers-massive-style").attr("style", `min-height: ${articlesDivHeight}px`);
    }

    function toggleContainer(containerIndex) {
        if ($(`#toggleContainer-${containerIndex}`).hasClass("fa-minus")) {
            $(`#container-articles-table-${containerIndex}`).fadeOut();
            $(`#toggleContainer-${containerIndex}`).removeClass("fa-minus");
            $(`#toggleContainer-${containerIndex}`).addClass("fa-plus");
        } else {
            $(`#container-articles-table-${containerIndex}`).fadeIn();
            $(`#toggleContainer-${containerIndex}`).removeClass("fa-plus");
            $(`#toggleContainer-${containerIndex}`).addClass("fa-minus");
        }
    }

    function toggleContainers() {
        if ($("#btnToggleContainers").html().includes("Expandir")) {
            $(".fa-plus").addClass("fa-minus");
            $(".fa-plus").removeClass("fa-plus");
            $(`.containersTable`).show();
            $("#btnToggleContainers").html('Reducir todos los contenedores');
        } else {
            $(".fa-minus").addClass("fa-plus");
            $(".fa-minus").removeClass("fa-minus");
            $(`.containersTable`).hide();
            $("#btnToggleContainers").html('Expandir todos los contenedores');
        }
    }

    function GetDateFormat(date) {
        if (navigator.languages != null && navigator.languages[0].includes("es")) {
            const parts = date.split("/");
            const dt = new Date(parseInt(parts[2], 10),
                parseInt(parts[1], 10) - 1,
                parseInt(parts[0], 10));

            return dt.toLocaleString("en-US")
        } else {
            const parts = date.split("/");
            const dt = new Date(parseInt(parts[2], 10),
                parseInt(parts[1], 10) - 1,
                parseInt(parts[0], 10));

            return dt.toLocaleDateString();
        }
    }

    function GetSpanishDate(date) {
        if (date && date !== null) {
            const dateArray = date.split("-");
            return `${dateArray[2]}/${dateArray[1]}/${dateArray[0]}`;
        }

        return "";
    }

    function GetEnglishDate(date) {
        if (date && date !== null) {
            const dateArray = date.split("/");
            return `${dateArray[2]}-${dateArray[0]}-${dateArray[1]}`;
        }

        return "";
    }

    function addDays(date, days) {
        var result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function formatNumber(amount) {
        return parseFloat(amount)
            .toFixed(2)
            .replace(/\d(?=(\d{3})+\.)/g, "$&,");
    }

</script>